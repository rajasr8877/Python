<policies>
    <inbound>
        <base />
        <set-variable name="blockId" value="@(System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(context.Request.Headers.GetValueOrDefault("blockId",""))))" />
        <set-method>PUT</set-method>
        <set-header name="x-ms-blob-type" exists-action="override">
            <value>BlockBlob</value>
        </set-header>
        <set-variable name="filename" value="@(context.Request.Headers.GetValueOrDefault("filename", "").Substring(context.Request.Headers.GetValueOrDefault("filename", "").LastIndexOf("/") + 1))" />
        <set-header name="x-ms-version" exists-action="override">
            <value>2020-02-10</value>
        </set-header>
        <set-header name="Authorization" exists-action="delete" />
        <set-backend-service base-url="@(string.Format("https://{{storageAccountName}}.blob.core.windows.net/files/{0}?comp=block&blockid={1}&{{SASToken}}", context.Variables.GetValueOrDefault("filename"), context.Variables.GetValueOrDefault("blockId")))" />
        <rewrite-uri template="?" />
    </inbound>
    <backend>
        <forward-request timeout="600" />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>